<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المبيعات والمصروفات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .modal { display: none; }
        .modal.active { display: flex; }
        @media print {
            body * { visibility: hidden; }
            #invoice-modal, #invoice-modal * { visibility: visible; }
            #invoice-modal { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-600">نظام إدارة المبيعات والمصروفات</h1>
        </header>

        <div class="bg-white shadow-md rounded-lg p-4 mb-6 flex flex-wrap justify-center gap-2">
            <button onclick="showView('sales-view')" class="tab-button bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">تسجيل المبيعات</button>
            <button onclick="showView('inventory-view')" class="tab-button bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">إدارة المخزون</button>
            <button onclick="showView('expenses-view')" class="tab-button bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">المصروفات</button>
            <button onclick="showView('reports-view')" class="tab-button bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">التقارير</button>
        </div>

        <!-- قسم تسجيل المبيعات -->
        <main id="sales-view" class="view-section">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">إضافة منتج للبيع</h2>
                    <form id="add-to-cart-form">
                        <div class="mb-4">
                            <label for="sale-product-select" class="block mb-2 font-medium">اختر منتجًا:</label>
                            <select id="sale-product-select" class="w-full p-2 border rounded-md bg-gray-50" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="sale-quantity" class="block mb-2 font-medium">الكمية:</label>
                            <input type="number" id="sale-quantity" value="1" min="1" class="w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600 font-bold">إضافة للفاتورة</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">الفاتورة الحالية</h2>
                    <div id="cart-items" class="mb-4 max-h-64 overflow-y-auto"></div>
                    <div class="border-t pt-4">
                        <div class="text-xl font-bold mb-4">
                            الإجمالي: <span id="cart-total" class="text-blue-600">0.00</span> جنيه
                        </div>
                        <button id="complete-sale-btn" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 font-bold text-lg disabled:bg-gray-400" disabled>إتمام البيع</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- قسم إدارة المخزون -->
        <div id="inventory-view" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">إضافة منتج جديد</h2>
                    <form id="add-product-form">
                        <div class="mb-4">
                            <label for="product-name" class="block mb-2 font-medium">اسم المنتج:</label>
                            <input type="text" id="product-name" class="w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="product-price" class="block mb-2 font-medium">السعر (جنيه):</label>
                            <input type="number" id="product-price" min="0" step="0.01" class="w-full p-2 border rounded-md" required>
                        </div>
                         <div class="mb-4">
                            <label for="product-stock" class="block mb-2 font-medium">الكمية المتاحة:</label>
                            <input type="number" id="product-stock" min="0" class="w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 font-bold">إضافة للمخزون</button>
                    </form>
                    <div class="mt-8 border-t pt-6">
                         <h3 class="text-xl font-semibold mb-4">النسخ الاحتياطي</h3>
                         <div class="space-y-3">
                            <button onclick="exportData()" class="w-full bg-teal-500 text-white py-2 rounded-md hover:bg-teal-600 font-bold">تصدير البيانات</button>
                            <button onclick="document.getElementById('import-file-input').click()" class="w-full bg-orange-500 text-white py-2 rounded-md hover:bg-orange-600 font-bold">استيراد البيانات</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                         </div>
                    </div>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">قائمة المنتجات في المخزون</h2>
                    <div class="max-h-[32rem] overflow-y-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="p-3">اسم المنتج</th>
                                    <th class="p-3">السعر</th>
                                    <th class="p-3">الكمية</th>
                                    <th class="p-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قسم المصروفات -->
        <div id="expenses-view" class="view-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">إضافة مصروف جديد</h2>
                    <form id="add-expense-form">
                        <div class="mb-4">
                            <label for="expense-description" class="block mb-2 font-medium">بيان المصروف:</label>
                            <input type="text" id="expense-description" class="w-full p-2 border rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="expense-amount" class="block mb-2 font-medium">المبلغ (جنيه):</label>
                            <input type="number" id="expense-amount" min="0" step="0.01" class="w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="w-full bg-red-500 text-white py-2 rounded-md hover:bg-red-600 font-bold">إضافة مصروف</button>
                    </form>
                </div>
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">سجل المصروفات</h2>
                    <div class="max-h-[32rem] overflow-y-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="p-3">التاريخ</th>
                                    <th class="p-3">البيان</th>
                                    <th class="p-3">المبلغ</th>
                                    <th class="p-3">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- قسم التقارير -->
        <div id="reports-view" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">التقرير المالي</h2>
                <div class="flex flex-wrap gap-4 items-center mb-6">
                    <button onclick="generateReport('daily')" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">تقرير اليوم</button>
                    <button onclick="generateReport('monthly')" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">تقرير الشهر</button>
                    <button onclick="generateReport('semi-annual')" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">نصف سنوي</button>
                    <div class="flex items-center gap-2">
                        <label for="start-date">من:</label>
                        <input type="date" id="start-date" class="p-2 border rounded-md">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="end-date">إلى:</label>
                        <input type="date" id="end-date" class="p-2 border rounded-md">
                    </div>
                    <button onclick="generateReport('custom')" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">عرض التقرير</button>
                </div>
                <div id="report-output" class="mt-6"></div>
            </div>
        </div>
    </div>

    <!-- نافذة إتمام البيع -->
    <div id="complete-sale-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">تأكيد عملية البيع</h2>
            <form id="complete-sale-form">
                <div class="mb-4">
                    <label class="block mb-2 font-medium">طريقة الدفع:</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="paymentMethod" value="cash" class="ml-2" checked> نقدي
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="paymentMethod" value="credit" class="ml-2"> آجل (دين)
                        </label>
                    </div>
                </div>
                <div id="customer-name-wrapper" class="mb-4 hidden">
                    <label for="customer-name" class="block mb-2 font-medium">اسم العميل:</label>
                    <input type="text" id="customer-name" class="w-full p-2 border rounded-md" placeholder="اكتب اسم العميل هنا">
                </div>
                <div class="mt-6 flex justify-end space-x-4 space-x-reverse">
                    <button type="button" onclick="closeModal('complete-sale-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">تأكيد البيع</button>
                </div>
            </form>
        </div>
    </div>

    <!-- نوافذ منبثقة أخرى (فاتورة، تأكيد، تعديل) -->
    <div id="invoice-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
            <div id="invoice-content" class="text-right">
                <h2 class="text-3xl font-bold text-center mb-6">فاتورة مبيعات</h2>
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <div>
                        <h3 class="font-bold text-lg">المتجر</h3>
                        <p>التاريخ: <span id="invoice-date"></span></p>
                    </div>
                    <div>
                        <p>رقم الفاتورة: <span id="invoice-id"></span></p>
                    </div>
                </div>
                <table class="w-full mb-6">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 text-right">المنتج</th>
                            <th class="p-2 text-center">الكمية</th>
                            <th class="p-2 text-center">سعر الوحدة</th>
                            <th class="p-2 text-left">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>
                <div class="flex justify-end">
                    <div class="w-full md:w-1/2">
                        <div class="flex justify-between p-2 bg-gray-100 rounded-t-lg">
                            <span class="font-semibold">الإجمالي الفرعي:</span>
                            <span id="invoice-subtotal"></span>
                        </div>
                        <div class="flex justify-between p-2 bg-blue-600 text-white rounded-b-lg font-bold text-xl">
                            <span>المبلغ الإجمالي:</span>
                            <span id="invoice-total"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 text-center no-print">
                <button onclick="window.print()" class="bg-green-500 text-white px-8 py-2 rounded-md hover:bg-green-600">طباعة</button>
                <button onclick="closeModal('invoice-modal')" class="bg-red-500 text-white px-8 py-2 rounded-md hover:bg-red-600">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="confirm-message" class="mb-4 text-lg"></p>
            <div class="space-x-4 space-x-reverse">
                <button id="confirm-yes" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">نعم</button>
                <button id="confirm-no" class="bg-gray-300 px-6 py-2 rounded-md hover:bg-gray-400">لا</button>
            </div>
        </div>
    </div>
    <div id="edit-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">تعديل بيانات المنتج</h2>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id">
                <div class="mb-4">
                    <label for="edit-product-name" class="block mb-2 font-medium">اسم المنتج:</label>
                    <input type="text" id="edit-product-name" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="edit-product-price" class="block mb-2 font-medium">السعر (جنيه):</label>
                    <input type="number" id="edit-product-price" min="0" step="0.01" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="edit-product-stock" class="block mb-2 font-medium">الكمية المتاحة:</label>
                    <input type="number" id="edit-product-stock" min="0" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mt-6 flex justify-end space-x-4 space-x-reverse">
                    <button type="button" onclick="closeModal('edit-product-modal')" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">إلغاء</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">حفظ التعديلات</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- تعريف عناصر الواجهة ---
    const views = document.querySelectorAll('.view-section');
    const tabButtons = document.querySelectorAll('.tab-button');
    const inventoryList = document.getElementById('inventory-list');
    const expensesList = document.getElementById('expenses-list');
    const saleProductSelect = document.getElementById('sale-product-select');
    const cartItemsDiv = document.getElementById('cart-items');
    const cartTotalSpan = document.getElementById('cart-total');
    const completeSaleBtn = document.getElementById('complete-sale-btn');
    const reportOutput = document.getElementById('report-output');
    
    // عناصر نماذج الإدخال
    const addProductForm = document.getElementById('add-product-form');
    const addExpenseForm = document.getElementById('add-expense-form');
    const addToCartForm = document.getElementById('add-to-cart-form');
    const editProductForm = document.getElementById('edit-product-form');
    const completeSaleForm = document.getElementById('complete-sale-form');
    const importFileInput = document.getElementById('import-file-input');
    const customerNameWrapper = document.getElementById('customer-name-wrapper');
    const customerNameInput = document.getElementById('customer-name');

    // --- إدارة البيانات ---
    let inventory = [];
    let sales = [];
    let expenses = [];
    let cart = [];

    // --- دوال التعامل مع البيانات ---
    const saveDataToFile = () => {
        const data = { inventory, sales, expenses };
        localStorage.setItem('fullSalesData', JSON.stringify(data));
    };

    const loadDataFromFile = () => {
        const dataFromStorage = localStorage.getItem('fullSalesData');
        if (dataFromStorage) {
            const data = JSON.parse(dataFromStorage);
            inventory = data.inventory || [];
            sales = data.sales || [];
            expenses = data.expenses || [];
        } else {
            inventory = [{ id: 1, name: 'منتج تجريبي', price: 100, stock: 10 }];
            sales = [];
            expenses = [];
        }
    };

    // --- دوال العرض والتحديث ---
    const renderAll = () => {
        renderInventory();
        renderSaleOptions();
        renderCart();
        renderExpenses();
    };

    window.showView = (viewId) => {
        views.forEach(view => view.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        tabButtons.forEach(btn => {
            btn.classList.replace('bg-blue-500', 'bg-gray-500');
            btn.classList.replace('bg-red-500', 'bg-gray-500');
        });
        const activeButton = Array.from(tabButtons).find(btn => btn.getAttribute('onclick').includes(viewId));
        if (viewId === 'expenses-view') {
             activeButton.classList.replace('bg-gray-500', 'bg-red-500');
        } else {
             activeButton.classList.replace('bg-gray-500', 'bg-blue-500');
        }
       
        if (viewId === 'reports-view') {
            generateReport('daily');
        }
    };
    
    window.openModal = (modalId) => document.getElementById(modalId).classList.add('active');
    window.closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

    // --- إدارة المخزون ---
    const renderInventory = () => {
        inventoryList.innerHTML = '';
        if (inventory.length === 0) {
            inventoryList.innerHTML = '<tr><td colspan="4" class="text-center p-4">المخزون فارغ.</td></tr>';
            return;
        }
        inventory.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-3 font-medium">${product.name}</td>
                <td class="p-3">${product.price.toFixed(2)}</td>
                <td class="p-3 ${product.stock < 5 ? 'text-red-500 font-bold' : ''}">${product.stock}</td>
                <td class="p-3 space-x-2 space-x-reverse">
                    <button onclick="openEditModal(${product.id})" class="text-blue-500 hover:text-blue-700">تعديل</button>
                    <button onclick="deleteProduct(${product.id})" class="text-red-500 hover:text-red-700">حذف</button>
                </td>
            `;
            inventoryList.appendChild(row);
        });
    };

    addProductForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newProduct = {
            id: Date.now(),
            name: document.getElementById('product-name').value,
            price: parseFloat(document.getElementById('product-price').value),
            stock: parseInt(document.getElementById('product-stock').value)
        };
        inventory.push(newProduct);
        saveDataToFile();
        renderAll();
        addProductForm.reset();
    });

    window.deleteProduct = (productId) => {
        showConfirm('هل أنت متأكد من حذف هذا المنتج؟ سيتم حذفه نهائياً.', () => {
            inventory = inventory.filter(product => product.id !== productId);
            saveDataToFile();
            renderAll();
        });
    };

    window.openEditModal = (productId) => {
        const product = inventory.find(p => p.id === productId);
        if (product) {
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-price').value = product.price;
            document.getElementById('edit-product-stock').value = product.stock;
            openModal('edit-product-modal');
        }
    };

    editProductForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const productId = parseInt(document.getElementById('edit-product-id').value);
        const productIndex = inventory.findIndex(p => p.id === productId);
        if (productIndex > -1) {
            inventory[productIndex].name = document.getElementById('edit-product-name').value;
            inventory[productIndex].price = parseFloat(document.getElementById('edit-product-price').value);
            inventory[productIndex].stock = parseInt(document.getElementById('edit-product-stock').value);
            saveDataToFile();
            renderAll();
            closeModal('edit-product-modal');
        }
    });

    // --- إدارة المصروفات ---
    const renderExpenses = () => {
        expensesList.innerHTML = '';
        if (expenses.length === 0) {
            expensesList.innerHTML = '<tr><td colspan="4" class="text-center p-4">لا توجد مصروفات مسجلة.</td></tr>';
            return;
        }
        [...expenses].reverse().forEach(expense => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-3">${new Date(expense.date).toLocaleDateString('ar-EG')}</td>
                <td class="p-3 font-medium">${expense.description}</td>
                <td class="p-3 text-red-600 font-semibold">${expense.amount.toFixed(2)}</td>
                <td class="p-3">
                    <button onclick="deleteExpense(${expense.id})" class="text-gray-500 hover:text-red-700">حذف</button>
                </td>
            `;
            expensesList.appendChild(row);
        });
    };
    
    addExpenseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newExpense = {
            id: Date.now(),
            description: document.getElementById('expense-description').value,
            amount: parseFloat(document.getElementById('expense-amount').value),
            date: new Date().toISOString()
        };
        expenses.push(newExpense);
        saveDataToFile();
        renderExpenses();
        addExpenseForm.reset();
    });

    window.deleteExpense = (expenseId) => {
        showConfirm('هل أنت متأكد من حذف هذا المصروف؟', () => {
            expenses = expenses.filter(exp => exp.id !== expenseId);
            saveDataToFile();
            renderExpenses();
        });
    };


    // --- إدارة المبيعات والفواتير ---
    const renderSaleOptions = () => {
        saleProductSelect.innerHTML = '<option value="" disabled selected>-- اختر منتجًا --</option>';
        inventory.filter(p => p.stock > 0).forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (المتاح: ${product.stock})`;
            saleProductSelect.appendChild(option);
        });
    };

    const renderCart = () => {
        cartItemsDiv.innerHTML = '';
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<p class="text-center text-gray-500">الفاتورة فارغة.</p>';
            completeSaleBtn.disabled = true;
            cartTotalSpan.textContent = '0.00';
            return;
        }
        let total = 0;
        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex justify-between items-center p-2 border-b';
            itemDiv.innerHTML = `
                <div>
                    <p class="font-semibold">${item.name}</p>
                    <p class="text-sm text-gray-600">${item.quantity} x ${item.price.toFixed(2)} جنيه</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold">${itemTotal.toFixed(2)} جنيه</span>
                    <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                </div>
            `;
            cartItemsDiv.appendChild(itemDiv);
        });
        cartTotalSpan.textContent = total.toFixed(2);
        completeSaleBtn.disabled = false;
    };
    
    addToCartForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const productId = parseInt(saleProductSelect.value);
        const quantity = parseInt(document.getElementById('sale-quantity').value);
        const product = inventory.find(p => p.id === productId);

        if (!product) { alert('الرجاء اختيار منتج.'); return; }
        if (quantity > product.stock) { alert('الكمية المطلوبة أكبر من المتاح في المخزون.'); return; }

        const existingCartItem = cart.find(item => item.id === productId);
        if (existingCartItem) {
            if (existingCartItem.quantity + quantity > product.stock) {
                 alert('إجمالي الكمية في الفاتورة يتجاوز المخزون المتاح.');
                 return;
            }
            existingCartItem.quantity += quantity;
        } else {
            cart.push({ ...product, quantity: quantity });
        }
        
        renderCart();
        addToCartForm.reset();
        document.getElementById('sale-quantity').value = 1;
    });

    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        renderCart();
    };
    
    completeSaleBtn.addEventListener('click', () => {
        if (cart.length > 0) {
            openModal('complete-sale-modal');
        }
    });

    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            customerNameWrapper.classList.toggle('hidden', e.target.value !== 'credit');
        });
    });

    completeSaleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const paymentMethod = e.target.elements.paymentMethod.value;
        const customerName = customerNameInput.value;

        if (paymentMethod === 'credit' && !customerName.trim()) {
            alert('الرجاء إدخال اسم العميل للمبيعات الآجلة.');
            return;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const newSale = {
            id: Date.now(),
            date: new Date().toISOString(),
            items: [...cart],
            total: total,
            paymentMethod: paymentMethod,
            customerName: paymentMethod === 'credit' ? customerName.trim() : null
        };

        sales.push(newSale);

        cart.forEach(cartItem => {
            const inventoryItem = inventory.find(invItem => invItem.id === cartItem.id);
            if (inventoryItem) inventoryItem.stock -= cartItem.quantity;
        });

        saveDataToFile();
        renderInvoice(newSale);
        openModal('invoice-modal');

        cart = [];
        renderAll();
        closeModal('complete-sale-modal');
        completeSaleForm.reset();
        customerNameWrapper.classList.add('hidden');
    });

    const renderInvoice = (sale) => {
        const invoiceModalContent = document.getElementById('invoice-modal');
        invoiceModalContent.innerHTML = `
            <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto">
                <div id="invoice-content" class="text-right">
                    <h2 class="text-3xl font-bold text-center mb-6">فاتورة مبيعات</h2>
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                        <div>
                            <h3 class="font-bold text-lg">المتجر</h3>
                            <p>التاريخ: <span id="invoice-date">${new Date(sale.date).toLocaleDateString('ar-EG')}</span></p>
                        </div>
                        <div>
                            <p>رقم الفاتورة: <span id="invoice-id">${sale.id}</span></p>
                        </div>
                    </div>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 text-right">المنتج</th>
                                <th class="p-2 text-center">الكمية</th>
                                <th class="p-2 text-center">سعر الوحدة</th>
                                <th class="p-2 text-left">الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items">
                            ${sale.items.map(item => `
                                <tr class="border-b">
                                    <td class="p-2">${item.name}</td>
                                    <td class="p-2 text-center">${item.quantity}</td>
                                    <td class="p-2 text-center">${item.price.toFixed(2)}</td>
                                    <td class="p-2 text-left">${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/2">
                            <div class="flex justify-between p-2 bg-gray-100 rounded-t-lg">
                                <span class="font-semibold">الإجمالي الفرعي:</span>
                                <span>${sale.total.toFixed(2)} جنيه</span>
                            </div>
                            <div class="flex justify-between p-2 bg-blue-600 text-white rounded-b-lg font-bold text-xl">
                                <span>المبلغ الإجمالي:</span>
                                <span>${sale.total.toFixed(2)} جنيه</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center no-print">
                    <button onclick="window.print()" class="bg-green-500 text-white px-8 py-2 rounded-md hover:bg-green-600">طباعة</button>
                    <button onclick="closeModal('invoice-modal')" class="bg-red-500 text-white px-8 py-2 rounded-md hover:bg-red-600">إغلاق</button>
                </div>
            </div>
        `;
    };

    // --- وظائف التقارير ---
    window.generateReport = (period) => {
        let startDate;
        let endDate = new Date();
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        switch (period) {
            case 'daily':
                startDate = new Date();
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'monthly':
                startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                endDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);
                endDate.setHours(23, 59, 59, 999);
                break;
            case 'semi-annual':
                 startDate = new Date(endDate.getFullYear(), endDate.getMonth() - 5, 1);
                 endDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);
                 endDate.setHours(23, 59, 59, 999);
                 break;
            case 'custom':
                if (!startDateInput.value || !endDateInput.value) {
                    reportOutput.innerHTML = '<p class="text-red-500">الرجاء تحديد تاريخ البدء والانتهاء للتقرير المخصص.</p>';
                    return;
                }
                startDate = new Date(startDateInput.value);
                endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59, 999);
                break;
        }

        const filteredSales = sales.filter(s => {
            const saleDate = new Date(s.date);
            return saleDate >= startDate && saleDate <= endDate;
        });
        const filteredExpenses = expenses.filter(e => {
            const expenseDate = new Date(e.date);
            return expenseDate >= startDate && expenseDate <= endDate;
        });
        
        renderReportResults(filteredSales, filteredExpenses, startDate, endDate);
    };

    const renderReportResults = (reportSales, reportExpenses, startDate, endDate) => {
        const cashSales = reportSales.filter(s => s.paymentMethod === 'cash');
        const creditSales = reportSales.filter(s => s.paymentMethod === 'credit');
        const totalCashRevenue = cashSales.reduce((sum, sale) => sum + sale.total, 0);
        const totalCreditRevenue = creditSales.reduce((sum, sale) => sum + sale.total, 0);
        const totalExpenses = reportExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        const netIncome = totalCashRevenue - totalExpenses;

        const productSales = {};
        reportSales.forEach(sale => sale.items.forEach(item => {
            productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
        }));
        const bestSellers = Object.entries(productSales).sort(([, a], [, b]) => b - a).slice(0, 5);

        reportOutput.innerHTML = `
            <div class="border rounded-lg p-4">
                <h3 class="text-xl font-bold mb-4">التقرير المالي من ${startDate.toLocaleDateString('ar-EG')} إلى ${endDate.toLocaleDateString('ar-EG')}</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <p class="text-lg text-green-800">إيرادات نقدية</p>
                        <p class="text-3xl font-bold text-green-600">${totalCashRevenue.toFixed(2)}</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center">
                        <p class="text-lg text-red-800">إجمالي المصروفات</p>
                        <p class="text-3xl font-bold text-red-600">${totalExpenses.toFixed(2)}</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <p class="text-lg text-blue-800">صافي الدخل</p>
                        <p class="text-3xl font-bold ${netIncome >= 0 ? 'text-blue-600' : 'text-red-600'}">${netIncome.toFixed(2)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2">المبيعات الآجلة (الديون)</h4>
                        <div class="bg-yellow-50 p-4 rounded-md max-h-60 overflow-y-auto">
                            <div class="flex justify-between font-bold border-b pb-2 mb-2">
                                <span>الإجمالي:</span>
                                <span>${totalCreditRevenue.toFixed(2)} جنيه</span>
                            </div>
                            ${creditSales.length > 0 ? creditSales.map(sale => `
                                <div class="flex justify-between items-center text-sm mb-1">
                                    <span>${sale.customerName}</span>
                                    <span class="font-semibold">${sale.total.toFixed(2)} جنيه</span>
                                    <span class="text-gray-500">${new Date(sale.date).toLocaleDateString('ar-EG')}</span>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500">لا توجد مبيعات آجلة.</p>'}
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">المنتجات الأكثر مبيعًا</h4>
                        <div class="bg-gray-50 p-4 rounded-md">
                            ${bestSellers.length > 0 ? bestSellers.map(product => `
                                <div class="flex justify-between items-center mb-1">
                                    <span>${product[0]}</span>
                                    <span class="font-bold bg-gray-200 px-2 py-1 rounded">${product[1]} وحدة</span>
                                </div>
                            `).join('') : '<p class="text-center text-gray-500">لا توجد مبيعات.</p>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    };

    // --- وظائف مساعدة والتصدير/الاستيراد ---
    window.exportData = () => {
        const dataStr = JSON.stringify({ inventory, sales, expenses }, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `products_backup_${new Date().toISOString().slice(0, 10)}.json`;
        link.click();
        URL.revokeObjectURL(url);
    };

    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data.inventory) && Array.isArray(data.sales) && Array.isArray(data.expenses)) {
                    showConfirm('سيتم استبدال البيانات الحالية. هل أنت متأكد؟', () => {
                        inventory = data.inventory;
                        sales = data.sales;
                        expenses = data.expenses;
                        saveDataToFile();
                        renderAll();
                        alert('تم الاستيراد بنجاح!');
                    });
                } else { throw new Error('Invalid file format'); }
            } catch (error) {
                alert('خطأ: ملف الاستيراد غير صالح.');
            }
        };
        reader.readAsText(file);
        importFileInput.value = '';
    });
    
    const showConfirm = (message, callback) => {
        const confirmModalEl = document.getElementById('confirm-modal');
        const confirmMsg = document.getElementById('confirm-message');
        const yesBtn = document.getElementById('confirm-yes');
        const noBtn = document.getElementById('confirm-no');
        
        confirmMsg.textContent = message;
        openModal('confirm-modal');
        
        const yesHandler = () => {
            closeModal('confirm-modal');
            callback();
            cleanup();
        };
        const noHandler = () => {
            closeModal('confirm-modal');
            cleanup();
        };
        const cleanup = () => {
            yesBtn.removeEventListener('click', yesHandler);
            noBtn.removeEventListener('click', noHandler);
        };
        
        yesBtn.addEventListener('click', yesHandler);
        noBtn.addEventListener('click', noHandler);
    };

    // --- التشغيل الأولي ---
    loadDataFromFile();
    renderAll();
    showView('sales-view');
});
</script>

</body>
</html>
